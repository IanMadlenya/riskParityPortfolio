---
title: |
  | General Linear Constraints using riskParityPortfolio \vspace{0.2cm}
author: |
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 1
    latex_engine: xelatex
  bookdown::html_document2:
    base_format: prettydoc::html_pretty
    theme: tactile
    highlight: vignette
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 2
header-includes:
indent: yes
csl: ieee.csl
bibliography: refs.bib
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.retina = 2,
  out.width = "75%",
  dpi = 96
)
knit_hooks$set(pngquant = hook_pngquant)
# Help on bookdown: https://bookdown.org/yihui/bookdown/
# rmarkdown::render("vignettes/example.Rmd", "bookdown::html_document2")
# rmarkdown::render("vignettes/example.Rmd", "bookdown::pdf_document2")
```

-----------
> A short note about general linear constraints and risk parity portfolios

# The optimization problem with general linear constraints

In version 1.1, the package `riskParityPortfolio` solves the following optimization
problem
$$\begin{array}{ll}
\underset{\mathbf{w}}{\textsf{minimize}} &
R(\mathbf{w}) + \lambda F(\mathbf{w})\\
\textsf{subject to} & \texttt{sum}(\mathbf{w}) = 1,~~\mathbf{w}_{lb} \leq \mathbf{w} \leq \mathbf{w}_{ub},
\end{array}$$
where $R(\mathbf{w})$ is the risk parity function, $F(\mathbf{w})$ is a convex function (such as negative expected return or the portfolio variance), and $\lambda$ is a trade-off parameter.

In version 2.0, we added support for general linear constraints, i.e., `riskParityPortfolio` is now able
to solve the following problem
$$\begin{array}{ll}
\underset{\mathbf{w}}{\textsf{minimize}} &
R(\mathbf{w}) + \lambda F(\mathbf{w})\\
\textsf{subject to} & \mathbf{C}\mathbf{w} = \mathbf{c},~~\mathbf{D}\mathbf{w} \leq \mathbf{d}
\end{array}$$

Users interested in the details of the algorithm behind the solution for the aforementioned problem
are refered to section V (*Advanced Solving Approaches*) of [@FengPal2015riskparity]. In summary,
the algorithm fits well within the SCA framework, while preserving speed and scalability.

It was recently mentioned by [@RichardRoncalli2019] that the problem of designing risk parity
portfolios with general constraints is harder than it seems. Indeed, [@RichardRoncalli2019] shows
that, after imposing general linear constraints, the property of equal risk contributions (ERC)
is unlikely to be preserved among the assets affected by the constraints.

Let's check out a numerical example from [@RichardRoncalli2019]. Consider we have a universe of
eight assets and we would like to design a risk parity portfolio $\mathbf{w}$ satisfying the
following constraints:
$$ w_5 + w_6 + w_7 + w_8 \geq 30\%, $$ $$ w_2 + w_6 \geq w_1 + w_5 + 5\%, $$ and $$ \sum w_i = 100\% . $$

```{r}
library(riskParityPortfolio)
library(PerformanceAnalytics)

# compute the covariance matrix
vol <- c(0.05, 0.05, 0.07, 0.1, 0.15, 0.15, 0.15, 0.18)
Corr <- rbind(c(100,  80,  60, -20, -10, -20, -20, -20),
              c( 80, 100,  40, -20, -20, -10, -20, -20),
              c( 60,  40, 100,  50,  30,  20,  20,  30),
              c(-20, -20,  50, 100,  60,  60,  50,  60),
              c(-10, -20,  30,  60, 100,  90,  70,  70),
              c(-20, -10,  20,  60,  90, 100,  60,  70),
              c(-20, -20,  20,  50,  70,  60, 100,  70),
              c(-20, -20,  30,  60,  70,  70,  70, 100)) / 100
Sigma <- Corr * (vol %o% vol)

Cmat <- matrix(1, 1, nrow(Sigma))
cvec <- c(1)
Dmat <- matrix(c(rep(0, 4), rep(-1, 4)), nrow = 1)
dvec <- c(-0.3)

# define linear constraints
Cmat <- matrix(1, 1, nrow(Sigma))
cvec <- c(1)
Dmat <- matrix(0, 2, 8)
Dmat[1, ] <- c(rep(0, 4), rep(-1, 4))
Dmat[2, ] <- c(1, -1, 0, 0, 1, -1, 0, 0)
dvec <- c(-0.3, -0.05)

# design portfolio
rpp <- riskParityPortfolio(Sigma, method = "sca",
                           Cmat = Cmat, cvec = cvec,
                           Dmat = Dmat, dvec = dvec)
# plot portfolio weights
barplot(100 * rpp$w,
        main = "Portfolio weights",
        xlab = "stocks", ylab = "Relative weight value", beside = TRUE, col = heat.colors(1))
# plot the risk contributions
barplot(100 * rpp$risk_contribution / sum(rpp$risk_contribution),
        main = "Risk contributions",
        xlab = "stocks", ylab = "Relative contribution", beside = TRUE,  col = heat.colors(1))

# Are the constraints satisfied?
# equality constraints
print(Cmat %*% rpp$w)
# inequality constraints
print(Dmat %*% rpp$w)
```
As we can observe, the risk contributions are somewhat clustered according to the relationship
among assets defined by the linear constraints, as mentioned by [@RichardRoncalli2019].

The results obtained by our implementation agree to those reported by [@RichardRoncalli2019].

# References {-}
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent



