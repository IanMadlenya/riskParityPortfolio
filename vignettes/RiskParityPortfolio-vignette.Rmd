---
title: "Design of Risk Parity Portfolios"
author: "Convex Group - HKUST"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    base_format: prettydoc::html_pretty
    theme: tactile
    highlight: vignette
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 2
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
header-includes:
  \allowdisplaybreaks
indent: yes
csl: ieee.csl
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Design of Risk Parity Portfolios}
  %\VignetteKeyword{portfolio, risk-parity, risk, optimization}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.retina = 2,
  out.width = "75%",
  dpi = 96
)
knit_hooks$set(pngquant = hook_pngquant)
#Help on bookdown: https://bookdown.org/yihui/bookdown/
#rmarkdown::render("vignettes/SparseIndexTracking-vignette.Rmd", "all")
#rmarkdown::render("vignettes/SparseIndexTracking-vignette.Rmd", "bookdown::html_document2")
#rmarkdown::render("vignettes/SparseIndexTracking-vignette.Rmd", "bookdown::pdf_document2")
#tools::compactPDF("vignettes/SparseIndexTracking-vignette.pdf", gs_quality = "ebook")
```

-----------
> This vignette illustrates the design of risk-parity portfolios, widely
used by practitioners in the financial industry, with the package
`riskParityPortfolio` (with a comparison with other packages) and gives a
description of the algorithms used.


# Comparison with other packages
Existing packages that I quickly found (a more thorough search is due):

- Package [cccp](https://CRAN.R-project.org/package=cccp) contains function
  `rp` (and the package itself may be useful for solving conic optimization problems)
- Package [FinCovRegularization](https://CRAN.R-project.org/package=FinCovRegularization)
  contains function `RiskParity` (the package may be useful for covariance matrix
  regularization, which is one of my upcoming projects...)
- Here you can find some simple code for risk parity portfolio:
  http://nakisa.org/bankr-useful-financial-r-snippets/risk-parity-portfolios-r/


Websites to check:

- Many links to docs related to risk parity here: https://www.r-bloggers.com/risk-parity/
- Nice intro articles that I can use in my slides for the course:
    + https://www.ipe.com/risk-parity-nice-idea-awkward-reality/40026.article
    + http://news.morningstar.com/pdfs/gmohiddenrisks.pdf
    + [https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1707478](https://poseidon01.ssrn.com/delivery.php?ID=627112031031103007064105094120011126017039000080068005126025111090071066081066070105028099044055108047124122088001010030007073027083008052040016105021001064069010102067081035117114090021065029088023126004127071004099065117107106112098070107115124110106&EXT=pdf)
- More links:
    + https://pdfs.semanticscholar.org/094d/24b924caa659442065401999d7a77e06953e.pdf
    + https://cdn2.hubspot.net/hubfs/2529352/Blog/2010_03_nepc_risk_parity.pdf?t=1501681499185
    + [https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1271972](https://poseidon01.ssrn.com/delivery.php?ID=674066092020082067126002014081023101038046007020059034127067087110126097099074024028056033058006042055014026025104115125094096053082054001060113114077012099097084088041055020094031067088066022127012071031066030120074011017069123085091021101101072024&EXT=pdf)


# Usage of the package

```{r, cache = TRUE}
library(riskParityPortfolio)
library(xts)
library(quantmod)
library(PerformanceAnalytics)

set.seed(123)

N <- 10
stocks_index <- c(1:N)
Sigma <- diag(stocks_index ^ 2)
Sigma[2, 1] <- 10
Sigma[1, 2] <- 10
S <- matrix(runif(N ^ 2), nrow = N)
Sigma <- Sigma + S

# compute the portfolio weights for the case when Sigma is diagonal
w_diag <- 1 / sqrt(diag(Sigma))
w_diag <- w_diag/sum(w_diag)
```

## Single-index case
```{r, cache = TRUE}
res_gen <- riskParityPortfolioGenSolver(Sigma, formulation = "single-index")
res_qp <- riskParityPortfolioSCA(Sigma, formulation = "single-index")

w_all <- cbind(res_gen$w, res_qp$w, w_diag)
colnames(w_all) <- c("risk-parity-gen-solver", "risk-parity-sca", "risk-parity-diag")
rownames(w_all) <- stocks_index
round(w_all, digits = 2)
barplot(t(w_all),
        main = "Portfolio allocation", xlab = "stocks", ylab = "dollars", beside = TRUE,
        legend = colnames(w_all), col = rainbow8equal[1:3])

risk_contrib_all <- cbind(res_gen$risk_contribution, res_qp$risk_contribution,
                          w_diag * (Sigma %*% w_diag))
colnames(risk_contrib_all) <- c("rc-gen-solver", "rc-sca", "rc-diag")
rownames(risk_contrib_all) <- stocks_index
barplot(t(risk_contrib_all),
        main = "Risk contribution", xlab = "stocks", beside = TRUE,
        legend = colnames(w_all), col = rainbow8equal[1:3])
plot(res_gen$elapsed_time, res_gen$obj_fun, type = "b", pch=19, cex=.6,
     col = "red", xlab = "Elapsed time (seconds)",
     ylab = "Objective function", main = "Convergence trend versus CPU time")
lines(res_qp$elapsed_time, res_qp$obj_fun, type = "b", pch=18, cex=.8,
      col = "blue")
legend("topright", legend=c("risk-parity-gen-solver", "risk-parity-sca"),
       col=c("red", "blue"), lty=c(1, 1), cex=0.8)
```

## Double-index case
```{r, cache = TRUE}
res_gen <- riskParityPortfolioGenSolver(Sigma, formulation = "double-index")
res_qp <- riskParityPortfolioSCA(Sigma, formulation = "double-index")

w_all <- cbind(res_gen$w, res_qp$w, w_diag)
colnames(w_all) <- c("risk-parity-gen-solver", "risk-parity-sca", "risk-parity-diag")
rownames(w_all) <- stocks_index
round(w_all, digits = 2)
barplot(t(w_all),
        main = "Portfolio allocation", xlab = "stocks", ylab = "dollars", beside = TRUE,
        legend = colnames(w_all), col = rainbow8equal[1:3])

risk_contrib_all <- cbind(res_gen$risk_contribution, res_qp$risk_contribution,
                          w_diag * (Sigma %*% w_diag))
colnames(risk_contrib_all) <- c("rc-gen-solver", "rc-sca", "rc-diag")
rownames(risk_contrib_all) <- stocks_index
barplot(t(risk_contrib_all),
        main = "Risk contribution", xlab = "stocks", beside = TRUE,
        legend = colnames(w_all), col = rainbow8equal[1:3])
plot(res_gen$elapsed_time, res_gen$obj_fun, type = "b", pch=19, cex=.6,
     col = "red", xlab = "Elapsed time (seconds)",
     ylab = "Objective function", main = "Convergence trend versus CPU time")
lines(res_qp$elapsed_time, res_qp$obj_fun, type = "b", pch=18, cex=.8,
      col = "blue")
legend("topright", legend=c("risk-parity-gen-solver", "risk-parity-sca"),
       col=c("red", "blue"), lty=c(1, 1), cex=0.8)
```


## Test with large number of stocks, single-index case
```{r, cache = TRUE}
set.seed(123)

N <- 100
stocks_index <- c(1:N)
Sigma <- diag(stocks_index ^ 2)
S <- matrix(runif(N ^ 2), nrow = N)
Sigma <- Sigma + S

res_gen <- riskParityPortfolioGenSolver(Sigma, formulation = "single-index")
res_gen_nograd <- riskParityPortfolioGenSolver(Sigma,
                                               formulation = "single-index",
                                               use_gradient = FALSE)
res_qp <- riskParityPortfolioSCA(Sigma, formulation = "single-index")

plot(res_gen$elapsed_time, res_gen$obj_fun, type = "b", pch=19, cex=.6,
     col = "red", xlab = "Elapsed time (seconds)",
     ylab = "Objective function", main = "Convergence trend versus CPU time")
lines(res_gen_nograd$elapsed_time, res_gen_nograd$obj_fun, type = "b", pch=18, cex=.8,
      col = "green")
lines(res_qp$elapsed_time, res_qp$obj_fun, type = "b", pch=18, cex=.8,
      col = "blue")
legend("topright", legend=c("risk-parity-gen-solver", "risk-parity-gen-solver-nograd",
                            "risk-parity-sca"),
       col=c("red", "green", "blue"), lty=c(1, 1, 1), cex=0.8)
```



# Explanation of the algorithms



# References {-}
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent
