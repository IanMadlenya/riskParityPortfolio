---
title: "Design of Risk Parity Portfolios"
author:
- name: "Vinicius Ze and Daniel P. Palomar"
  affiliation: "Hong Kong University of Science and Technology (HKUST)"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    base_format: prettydoc::html_pretty
    theme: tactile
    highlight: vignette
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 2
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
header-includes:
  \allowdisplaybreaks
indent: yes
csl: ieee.csl
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Design of Risk Parity Portfolios}
  %\VignetteKeyword{portfolio, risk-parity, risk, optimization}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.retina = 2,
  out.width = "75%",
  dpi = 96
)
knit_hooks$set(pngquant = hook_pngquant)
#Help on bookdown: https://bookdown.org/yihui/bookdown/
#rmarkdown::render("vignettes/RiskParityPortfolio-vignette.Rmd", "all")
#rmarkdown::render("vignettes/RiskParityPortfolio-vignette.Rmd", "bookdown::html_document2")
#rmarkdown::render("vignettes/RiskParityPortfolio-vignette.Rmd", "bookdown::pdf_document2")
#tools::compactPDF("vignettes/RiskParityPortfolio-vignette.pdf", gs_quality = "ebook")
```

-----------
> This vignette illustrates the design of risk-parity portfolios, widely
used by practitioners in the financial industry, with the package
`riskParityPortfolio` (with a comparison with other packages) and gives a
description of the algorithms used.


# Comparison with other packages
```{r}
library(riskParityPortfolio)
library(cccp)
library(FinCovRegularization)
library(microbenchmark)

N <- 100
V <- matrix(rnorm(N ^ 2), nrow = N)
Sigma <- V %*% t(V)

microbenchmark(RiskParity(Sigma))
microbenchmark(riskParityPortfolioSCA(Sigma, formulation = "rc-over-var"))
```
Existing packages that I quickly found (a more thorough search is due):

- Package [cccp](https://CRAN.R-project.org/package=cccp) contains function
  `rp` (and the package itself may be useful for solving conic optimization problems)
- Package [FinCovRegularization](https://CRAN.R-project.org/package=FinCovRegularization)
  contains function `RiskParity` (the package may be useful for covariance matrix
  regularization, which is one of my upcoming projects...)


# Usage of the package

```{r, message = FALSE}
library(riskParityPortfolio)
library(xts)
library(quantmod)
library(PerformanceAnalytics)

set.seed(123)

N <- 10
stocks_index <- c(1:N)
V <- matrix(rnorm(N ^ 2), nrow = N)
Sigma <- V %*% t(V)

# compute the portfolio weights for the case when Sigma is diagonal
res_diag <- riskParityPortfolioDiagSigma(Sigma)
```

## Formulations
In its simples version, the risk-parity portfolio aims at achieving parity of the risk contributions from the different assets:
$$w_i\left(\boldsymbol{\Sigma}\mathbf{w}\right)_i = w_j\left(\boldsymbol{\Sigma}\mathbf{w}\right)_j \qquad \forall i,j.$$

Assuming that $\boldsymbol{\Sigma}$ is diagonal and with the constraints $\mathbf{1}^T\mathbf{w}=1$ and $\mathbf{w}\ge\mathbf{0}$, the risk budgeting portfolio is
$$w_i = \frac{\sqrt{b_i}/\sqrt{\Sigma_{ii}}}{\sum_{k=1}^N\sqrt{b_k}/\sqrt{\Sigma_{kk}}}, \qquad i=1,\ldots,N.$$
In general, exact parity cannot be achieved and one needs to define a risk term to be minimized: $R(\mathbf{w}) = \sum_{i=1}^{N}\left(g_{i}\left(\mathbf{w}\right)\right)^{2}$. A double-index summation can also be used:
$R(\mathbf{w}) = \sum_{i,j=1}^{N}\left(g_{ij}\left(\mathbf{w}\right)\right)^{2}$.

We condiser the following formulations (equation numbers from the paper):

- Done. (16): rc double-index
- Done. (19): rc-over-b double-index
- Done. (18): rc-over-var-vs-b
- Done. (24): rc-over-var
- Done. (21): rc-over-sd vs b-times-sd
- Done. (20): rc-vs-b-times-var
- Done. (17): rc-vs-theta

- (22): rc-over-b vs theta


We can skip these in our first release, no need to go crazy:
- (26): group-rc-over-sd vs b-times-sd
- (31): factor-rc-over-sd vs b-times-sd
- (32): CVaR-rc-over-sd vs b-times-sd

And here give then one by one...

One of the earliest risk-parity portfolio formulations is
$$\begin{array}{ll}
\underset{\mathbf{w}}{\textsf{minimize}} & \sum_{i,j=1}^{N}\left(w_{i}\left(\boldsymbol{\Sigma}\mathbf{w}\right)_{i}-w_{j}\left(\boldsymbol{\Sigma}\mathbf{w}\right)_{j}\right)^{2}\\
\textsf{subject to} & \mathbf{1}^T\mathbf{w}=1,\quad\mathbf{w}\in\mathcal{W},
\end{array}$$
which corresponds to $g_{i,j}(\mathbf{w})=\mathbf{w}^T(\mathbf{M}_i-\mathbf{M}_j)\mathbf{w}$ (with $\mathcal{W}$ denoting some other constraints).

Another similar formulation is
$$\begin{array}{ll}
\underset{\mathbf{w},\theta}{\textsf{minimize}} & \sum_{i=1}^{N}\left(w_{i}\left(\boldsymbol{\Sigma}\mathbf{w}\right)_{i} - \theta\right)^{2}\\
\textsf{subject to} & \mathbf{1}^T\mathbf{w}=1,\quad\mathbf{w}\in\mathcal{W}.
\end{array}$$
which corresponds to $g_i(\mathbf{w})=\mathbf{w}^T\mathbf{M}_i\mathbf{w}-\theta$.

## Experiment with synthetic data: single-index case
```{r}
set.seed(123)
N <- 100
V <- matrix(rnorm(N ^ 2), nrow = N)
Sigma <- V %*% t(V)

res_slsqp <- riskParityPortfolioGenSolver(Sigma, formulation = "rc-over-var vs b",
                                          method = "slsqp")
res_slsqp_nograd <- riskParityPortfolioGenSolver(Sigma,
                                                 formulation = "rc-over-var vs b",
                                                 method = "slsqp",
                                                 use_gradient = FALSE)
res_alabama <- riskParityPortfolioGenSolver(Sigma,
                                            formulation = "rc-over-var vs b",
                                            method = "alabama")
res_alabama_nograd <- riskParityPortfolioGenSolver(Sigma,
                                                 formulation = "rc-over-var vs b",
                                                 method = "alabama",
                                                 use_gradient = FALSE)
res_sca <- riskParityPortfolioSCA(Sigma, formulation = "rc-over-var vs b")

plot(res_slsqp_nograd$elapsed_time, res_slsqp_nograd$obj_fun, type = "b",
     pch=19, cex=.6, col = "blue", xlab = "Elapsed time (seconds)",
     ylab = "Objective function", main = "Convergence trend versus CPU time",
     ylim = c(0, 0.01))
lines(res_alabama$elapsed_time, res_alabama$obj_fun, type = "b", pch=18, cex=.8,
      col = "red")
lines(res_alabama_nograd$elapsed_time, res_alabama_nograd$obj_fun, type = "b", pch=17,
      cex=.8, col = "purple")
lines(res_slsqp$elapsed_time, res_slsqp$obj_fun, type = "b", pch=16, cex=.8,
      col = "green")
lines(res_sca$elapsed_time, res_sca$obj_fun, type = "b", pch=15, cex=.8,
      col = "black")

legend("topright", legend=c("alabama-solver-nograd",
                            "alabama-solver",
                            "slsqp-solver-nograd",
                            "slsqp-solver",
                            "sca"),
       col=c("purple", "red", "blue", "green", "black"), lty=c(1, 1, 1), cex=0.8)
```

## Experiment with real data: single-index case
```{r}
library(sparseIndexTracking)
library(xts)
data(INDEX_2010)
Sigma <- cov(INDEX_2010$X)

res_slsqp <- riskParityPortfolioGenSolver(Sigma, formulation = "rc-over-var vs b",
                                          method = "slsqp")
res_slsqp_nograd <- riskParityPortfolioGenSolver(Sigma,
                                                 formulation = "rc-over-var vs b",
                                                 method = "slsqp",
                                                 use_gradient = FALSE)
res_alabama <- riskParityPortfolioGenSolver(Sigma,
                                            formulation = "rc-over-var vs b",
                                             method = "alabama")
res_alabama_nograd <- riskParityPortfolioGenSolver(Sigma,
                                                 formulation = "rc-over-var vs b",
                                                 method = "alabama",
                                                 use_gradient = FALSE)
res_sca <- riskParityPortfolioSCA(Sigma, formulation = "rc-over-var vs b")

plot(res_alabama_nograd$elapsed_time, res_alabama_nograd$obj_fun, type = "b",
     pch=19, cex=.6, col = "purple", xlab = "Elapsed time (seconds)",
     ylab = "Objective function", main = "Convergence trend versus CPU time")
lines(res_alabama$elapsed_time, res_alabama$obj_fun, type = "b", pch=18, cex=.8,
      col = "red")
lines(res_slsqp_nograd$elapsed_time, res_slsqp_nograd$obj_fun, type = "b", pch=17,
      cex=.8, col = "blue")
lines(res_slsqp$elapsed_time, res_slsqp$obj_fun, type = "b", pch=16, cex=.8,
      col = "green")
lines(res_sca$elapsed_time, res_sca$obj_fun, type = "b", pch=15, cex=.8,
      col = "black")

legend("topright", legend=c("alabama-solver-nograd",
                            "alabama-solver",
                            "slsqp-solver-nograd",
                            "slsqp-solver",
                            "sca"),
       col=c("purple", "red", "blue", "green", "black"), lty=c(1, 1, 1), cex=0.8)
```

# Explanation of the algorithms

# References {-}
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent
